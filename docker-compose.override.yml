# SPDX-FileCopyrightText: 2023 Ross Patterson <me@rpatterson.net>
#
# SPDX-License-Identifier: MIT

# Override `$ docker compose ...` configuration for development or testing here in this
# repo checkout.  Everything that may be used outside this checkout should be in
# `./docker-compose.yml`.
version: "3.8"

services:
  reuse:
    image: "docker.io/fsfe/reuse:latest-debian"
    profiles:
      - "lint"
    user: "${PUID:-1000}:${PGID:-${PUID:-1000}}"
    environment:
      TZ: "${TZ:-Etc/UTC}"
    volumes:
      - "${CHECKOUT_DIR:-.}/:/data/"
    command: >-
      lint

  # https://github.com/validator/validator/#the-nu-html-checker-vnu--
  vnu:
    image: "ghcr.io/validator/validator"
    profiles:
      - "lint"
    volumes:
      - "${CHECKOUT_DIR:-.}/:/mnt/"
    working_dir: "/mnt/"
    command: >-
      vnu --stdout --Werror --also-check-css --also-check-svg

  # https://github.com/svenkreiss/html5validator#html5-validator
  html5validator:
    image: "docker.io/cyb3rjak3/html5validator"
    profiles:
      - "lint"
    volumes:
      - "${CHECKOUT_DIR:-.}/:/mnt/"
    working_dir: "/mnt/"
    command: >-
      html5validator --show-warnings --also-check-css --also-check-svg
      --blacklist ".git" "var" "coverage" ".tox" "node_modules"

  pandoc:
    image: "docker.io/pandoc/core"
    profiles:
      - "release"
    user: "${PUID:-1000}:${PGID:-${PUID:-1000}}"
    volumes:
      - "${CHECKOUT_DIR:-.}/:/data/"
    entrypoint: "ash"
    # Strip reStructuredText directives unsupported in Markdown before converting and
    # converted Markdown that isn't widely supported, e.g. table of contents and tables
    # respectively:
    command: >-
      -xeu -c '
        grep -Ev "^ *\.\. +(contents)::.*" "./README.rst" |
        pandoc -f "rst" -t "gfm" | grep -Ev "^(\+-+\+|\|.*\|)$" >"./README.md"
      '
